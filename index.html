<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nudge Fleet Vehicle Log</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:18px; background:#f6f6f6; }
    .card { max-width:560px; margin:0 auto; background:#fff; border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    h1 { font-size:18px; margin:0 0 12px; }
    label { display:block; font-size:13px; margin:10px 0 6px; color:#333; }
    input, select, textarea, button { width:100%; padding:12px; font-size:16px; border:1px solid #ddd; border-radius:10px; box-sizing:border-box; }
    textarea { min-height:80px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    button { border:0; cursor:pointer; }
    .primary { background:#111; color:#fff; font-weight:650; }
    .tiny { font-size:12px; color:#666; margin-top:8px; }
    .ok { color:#0a7a2f; }
    .bad { color:#b00020; }
    .checkbox { display:flex; align-items:center; gap:10px; margin-top: 10px; }
    .checkbox input { width:auto; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Business Vehicle Log</h1>

    <div class="row">
      <div>
        <label>Action</label>
        <select id="log_type">
          <option value="checkout">Check-out</option>
          <option value="return">Return</option>
        </select>
      </div>
      <div>
        <label>Mileage</label>
        <input id="mileage" type="number" min="0" inputmode="numeric" placeholder="e.g. 43122" required />
      </div>
    </div>

    <label>Your name</label>
    <input id="employee_name" type="text" placeholder="First + last" required />

    <label>Photos (odometer required)</label>
    <input id="photos" type="file" accept="image/*" capture="environment" multiple />

    <label>Notes (optional)</label>
    <textarea id="notes" placeholder="Damage, gas level, issues, etc."></textarea>

    <div class="checkbox">
      <input type="checkbox" id="has_incident" />
      <label for="has_incident" style="margin:0;">Report incident / damage</label>
    </div>

    <div id="incidentFields" style="display:none;">
      <label>Incident type</label>
      <select id="incident_type">
        <option value="damage">Damage</option>
        <option value="accident">Accident</option>
        <option value="theft">Theft</option>
        <option value="other">Other</option>
      </select>

      <label>Severity (optional)</label>
      <select id="severity">
        <option value="">(optional)</option>
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
      </select>

      <label>Description</label>
      <textarea id="incident_description" placeholder="What happened? Where? Any details."></textarea>

      <label>Location (optional)</label>
      <input id="incident_location" type="text" placeholder="e.g. Brian Head, UT / parking lot" />

      <label>Police report # (optional)</label>
      <input id="police_report_number" type="text" placeholder="If applicable" />
    </div>

    <div style="height:12px"></div>
    <button class="primary" id="submitBtn">Submit</button>

    <p class="tiny" id="status"></p>
  </div>

<script>
  const SUPABASE_URL = "https://YOUR_PROJECT_REF.supabase.co";
  const EDGE_SUBMIT_URL = SUPABASE_URL.replace(/\/$/, "") + "/functions/v1/vehicle_log_submit";

  const qs = new URLSearchParams(location.search);
  const vehicle_id = qs.get("vehicle_id") || "";
  const k = qs.get("k") || "";

  const statusEl = document.getElementById("status");
  const submitBtn = document.getElementById("submitBtn");

  function setStatus(msg, cls="") {
    statusEl.className = "tiny " + cls;
    statusEl.textContent = msg;
  }

  if (!vehicle_id || !k) {
    setStatus("Missing vehicle_id or key in the URL. Use the QR code in the car.", "bad");
    submitBtn.disabled = true;
  }

  const hasIncident = document.getElementById("has_incident");
  const incidentFields = document.getElementById("incidentFields");
  hasIncident.addEventListener("change", () => {
    incidentFields.style.display = hasIncident.checked ? "block" : "none";
  });

  submitBtn.addEventListener("click", async () => {
    try {
      submitBtn.disabled = true;
      setStatus("Uploading…", "");

      const log_type = document.getElementById("log_type").value;
      const mileage = document.getElementById("mileage").value;
      const employee_name = document.getElementById("employee_name").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const photosInput = document.getElementById("photos");

      if (!employee_name) throw new Error("Name is required.");
      if (mileage === "" || Number(mileage) < 0) throw new Error("Mileage must be a non-negative number.");

      const files = Array.from(photosInput.files || []);
      if (files.length < 1) throw new Error("At least 1 photo required (odometer).");

      const form = new FormData();
      form.append("vehicle_id", vehicle_id);
      form.append("log_type", log_type);
      form.append("employee_name", employee_name);
      form.append("mileage", mileage);
      form.append("notes", notes);
      form.append("k", k);
      files.forEach((f) => form.append("photos", f, f.name));

      // Incident fields
      if (hasIncident.checked) {
        const incident_type = document.getElementById("incident_type").value;
        const severity = document.getElementById("severity").value;
        const desc = document.getElementById("incident_description").value.trim();
        const loc = document.getElementById("incident_location").value.trim();
        const prn = document.getElementById("police_report_number").value.trim();

        if (!desc) throw new Error("Incident description is required.");

        form.append("incident_type", incident_type);
        if (severity) form.append("severity", severity);
        form.append("incident_description", desc);
        if (loc) form.append("incident_location", loc);
        if (prn) form.append("police_report_number", prn);
      }

      const resp = await fetch(EDGE_SUBMIT_URL, { method: "POST", body: form });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) throw new Error(data?.error || `Submit failed (${resp.status})`);

      setStatus(`Saved ✅ Log ID: ${data.log_id}`, "ok");
      document.getElementById("mileage").value = "";
      document.getElementById("employee_name").value = "";
      document.getElementById("notes").value = "";
      photosInput.value = "";
      hasIncident.checked = false;
      incidentFields.style.display = "none";
      document.getElementById("incident_description").value = "";
      document.getElementById("incident_location").value = "";
      document.getElementById("police_report_number").value = "";
      document.getElementById("severity").value = "";
      document.getElementById("incident_type").value = "damage";
    } catch (e) {
      setStatus(e.message || "Something broke. Try again.", "bad");
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
</body>
</html>
